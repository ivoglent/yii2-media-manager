<?php
/**
 * @project  Investment Deals
 * @copyright Â© 2017 by ivoglent
 * @author ivoglent
 * @time  9/7/17.
 */


namespace ivoglent\media\manager\controllers;


use ivoglent\media\manager\models\Media;
use ivoglent\media\manager\models\MediaFile;
use yii\data\ActiveDataProvider;
use yii\web\Controller;
use yii\web\UnauthorizedHttpException;
use yii\web\UploadedFile;

class ManagerController extends Controller
{
    /**
     * @param \yii\base\Action $action
     * @return bool
     * @throws UnauthorizedHttpException
     */
    public function beforeAction($action)
    {
        if (\Yii::$app->user->isGuest){
            throw new UnauthorizedHttpException("Reuquired logged in user");
        }
        return parent::beforeAction($action); // TODO: Change the autogenerated stub
    }

    public function actionDialog()
    {
        $user = \Yii::$app->user->identity;
        $model = new Media();
        $model->created_by = $user->getId();
        $dataProvider = new ActiveDataProvider([
            'query' => Media::find()->where(['created_by' => $user->getId()]),
            'pagination' => [
                'pageSize' => 15
            ]
        ]);
        return $this->renderPartial('dialog', [
            'dataProvider' => $dataProvider,
            'model' => $model
        ]);
    }

    /**
     * @return string
     */
    public function actionUpload()
    {
        $model = new MediaFile();

        if (\Yii::$app->request->isPost) {
            $model->image = UploadedFile::getInstanceByName( 'file');
            if ($model->upload()) {
                // file is uploaded successfully
                return "success";
            }
        }
    }
}